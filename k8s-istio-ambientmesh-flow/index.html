
<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://haruband.github.io/js/theme.min.js" integrity="sha384-pb++s6uBRKaQv+iAXpgA/H3IlpLZdO14tTwuCI7uXmz4aaZdByoCcM+6BhynMq/1"></script>
  <link rel="stylesheet" href="https://haruband.github.io/abridge.css?h=98ebdf6fd3d59dfb2edf" />
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="base" content="https://haruband.github.io" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#333333" />
  <meta name="msapplication-TileColor" content="#333333" />
  <link rel="manifest" href="https://haruband.github.io/manifest.min.json" />
  <link rel="mask-icon" href="https://haruband.github.io/safari-pinned-tab.svg" color="#ff9900" />
  <link rel="icon" type="image/svg+xml" href="https://haruband.github.io/favicon.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://haruband.github.io/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://haruband.github.io/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://haruband.github.io/favicon-16x16.png" />
  <link rel="alternate" type="application/atom+xml" title="CodeBook Atom Feed" href="https://haruband.github.io/atom.xml" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <title>[K8S/Istio] AmbientMesh 동작 과정 분석 | CodeBook</title>
  <meta name="author" content="Inhyeok Kim" />
  <meta name="copyright" content="CodeBook" />
  <meta name="description" content="Haruband&#x27;s TechBlog" />
  <link rel="canonical" href="https://haruband.github.io/k8s-istio-ambientmesh-flow/" />
  <meta name="keywords" content="Arrow, Datafusion, Kubernetes" />
  <meta name="google-site-verification" content="Your Google Site verification code." />
  <meta name="msvalidate.01" content="Your Bing Site verification code." />
  <meta property="og:url" content="https://haruband.github.io/k8s-istio-ambientmesh-flow/" />
  <meta name="twitter:url" content="https://haruband.github.io/k8s-istio-ambientmesh-flow/" />
  <meta property="og:description" content="Haruband&#x27;s TechBlog" />
  <meta name="twitter:description" content="Haruband&#x27;s TechBlog" />
  <meta property="og:title" content="[K8S&#x2F;Istio] AmbientMesh 동작 과정 분석 | CodeBook" />
  <meta name="twitter:title" content="[K8S&#x2F;Istio] AmbientMesh 동작 과정 분석 | CodeBook" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://haruband.github.io/banner.png" />
  <meta property="og:image" content="https://haruband.github.io/banner.png" />
  <meta property="og:site_name" content="CodeBook" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:type" content="website" />
  <meta property="og:updated_time" content="2023-10-19" />
  <meta name="twitter:site" content="@your-user-name" />
  <meta name="twitter:creator" content="@your-user-name" />
  <script defer src="https://haruband.github.io/js/abridge.min.js?h=e0f9a881a665c86cce9c" integrity="sha384-QF67y7RnPkuDrJNQqn3/7nYxqxWkW/qHI7zN0WTES1aXbf+TotoByRBb835fUE6U"></script>
  <noscript><link rel="stylesheet" href="https://haruband.github.io/nojs.css" /></noscript>
</head>
<body>
  <header>
    <nav>
      <div><big><a href="https://haruband.github.io" title="CodeBook">CodeBook</a></big></div>
      <div>

        <div>
          <ul><li><a class="s110" href="https://haruband.github.io/archive/"> Posts </a></li><li><a class="s110" href="https://haruband.github.io/tags/"> Tags </a></li><li><i type="reset" id="mode" class="js svgs adjust"></i></ul>
        </div>

        <div>
          <div>
            <form autocomplete=off class="js" name="goSearch" id="searchbox">
              <div class="searchd">
                <input id="searchinput" type="text" placeholder="Search" title="Search" />
                <button type="submit" title="Search" class="svgs svgm search"></button>
              </div>
              <div class="results"><div id="suggestions"></div></div>
            </form>
          </div>
        </div>

      </div>
    </nav>
  </header>
  <main>
    <article>
      <h1><a href="https://haruband.github.io/k8s-istio-ambientmesh-flow/">[K8S&#x2F;Istio] AmbientMesh 동작 과정 분석</a></h1>

      <span class="s95"> Inhyeok Kim <span class="rpad"></span> October 19, 2023 <span class="rpad"></span>Updated: October 19, 2023 <span class="rpad"></span> #<a href="https://haruband.github.io/tags/k8s/">K8S</a>  #<a href="https://haruband.github.io/tags/kubernetes/">Kubernetes</a>  #<a href="https://haruband.github.io/tags/istio/">Istio</a>  #<a href="https://haruband.github.io/tags/ambientmesh/">AmbientMesh</a> </span>

    
        <div class="block">
      <div class="blockdiv">
        <a class="b s150" href="https://haruband.github.io/tags/istio/">Istio (Series)</a><br>
            <a href="https://haruband.github.io/k8s-istio-ambientmesh/">[K8S&#x2F;Istio] AmbientMesh 소개</a><br>
            <a class="scur" href="https://haruband.github.io/k8s-istio-ambientmesh-flow/">[K8S&#x2F;Istio] AmbientMesh 동작 과정 분석</a><br> 
          
            <a href="https://haruband.github.io/k8s-istio-ambientmesh-rpfilter/">[K8S&#x2F;Istio] AmbientMesh RPFilter 문제 분석</a><br>
            <a href="https://haruband.github.io/k8s-istio-ambientmesh-cilium/">[K8S&#x2F;Istio] AmbientMesh Cilium 문제 분석</a><br>
      </div>
    </div>


<p>오늘은 Istio 에서 공개한 AmbientMesh 의 동작 과정을 분석해보도록 하겠다. 성능이나 확장성 면에서 우수한 eBPF 모드를 기준으로 설명할 계획이며, CNI 는 Calico(+IPTables)를 사용하였다.</p>
<p>아래 그림은 출발지 파드(jupyterlab)에서 목적지 파드(nginx)로 패킷이 전달되는 과정을 보여주고 있다. (출발지 파드에서는 목적지 서비스(nginx)의 주소(172.16.52.69)로 접속하였다.) 목적지 파드는 프록시(Waypoint)가 설치된 네임스페이스(default)에 속해있기 때문에 패킷은 해당 프록시를 통해서 전달된다. 설명은 패킷이 전달되는 순서대로(그림에 표시된 1~8번까지의 숫자) 진행하도록 하겠다.</p>
<p><img src="https://haruband.github.io/k8s-istio-ambientmesh-flow/./istio-ambientmesh-flow.png" alt="istio.ambientmesh.flow" /></p>
<p>1번은 출발지 파드에서 패킷이 송신되는 단계이다. 패킷의 출발지 물리주소(4e:c8:60:12:7b:5b)는 출발지 파드(juypterlab)의 네트워크 장치(eth0)의 주소이고, 목적지 물리주소(ee:ee:ee:ee:ee:ee)는 출발지 파드의 호스트 네트워크 장치(veth0)의 주소이다. 그리고 패킷의 출발지/목적지 주소는 각각 출발지 파드(10.69.11.36)와 목적지 서비스(172.16.52.69)의 주소이다.</p>
<pre class="z-code"><code><span class="z-text z-plain"># packet header in 1 step
</span><span class="z-text z-plain">4e:c8:60:12:7b:5b &gt; ee:ee:ee:ee:ee:ee,
</span><span class="z-text z-plain">10.69.11.36.60348 &gt; 172.16.52.69.80: ...
</span></code></pre>
<p>출발지 파드의 네트워크 장치(eth0)를 통해 송신된 패킷은 VETH 로 연결된 호스트 네트워크 장치(veth0)로 전달되고, 호스트 네트워크 장치(veth0)의 ingress BPF 프로그램(A)에서는 패킷의 목적지 물리주소를 터널링 파드(ztunnel0)의 네트워크 장치(eth1)의 물리주소(3e:53:50:ac:00:d4)로 수정한 다음, 강제로 터널링 파드의 호스트 네트워크 장치(veth1)로 전달(redirect)한다. 그리고 호스트 네트워크 장치(veth1)로 전달된 패킷은 VETH 로 연결된 네트워크 장치(eth1)로 전달된다.</p>
<p>2번은 터널링 파드에서 패킷이 수신되는 단계이다. 수신된 패킷은 네트워크 장치(eth1)의 ingress BPF 프로그램(B)에서 강제로 Ztunnel 이 아웃바운드 포트(15001)로 대기(listen)하고 있는 소켓으로 전달된다. 이 때 생성(accept)되는 소켓의 로컬 주소는 전달받은 패킷의 목적지 주소인 목적지 서비스(172.16.52.69:80)의 주소이고, conntrack 맵에도 목적지 주소는 목적지 서비스(172.16.52.69:80)의 주소로 등록되어 있다.</p>
<pre class="z-code"><code><span class="z-text z-plain"># packet header in 2 step
</span><span class="z-text z-plain">4e:c8:60:12:7b:5b &gt; 3e:53:50:ac:00:d4,
</span><span class="z-text z-plain">10.69.11.36.60348 &gt; 172.16.52.69.80: ...
</span></code></pre>
<p>3번은 터널링 파드에서 패킷이 송신되는 단계이다. 목적지 서비스가 속해있는 네임스페이스가 프록시(Waypoint)를 사용하기 때문에 전달받은 패킷은 프록시(10.69.149.2)로 전달된다. 이때 패킷의 출발지 주소는 터널링 파드의 주소가 아닌 전달받은 패킷(2)의 출발지 주소인 출발지 파드의 주소(10.69.11.36)를 사용한다. 그렇다면 프록시가 보내는 패킷(응답)의 목적지 주소도 출발지 파드의 주소이겠지만, 출발지 파드가 받는 모든 패킷은 터널링 파드가 가로채기 때문에 문제없이 동작한다. 그리고 원래의 목적지 주소(172.16.52.69:80)는 HTTP/2 Connect 기반의 HBONE 프로토콜을 이용하여 Ztunnel 과 프록시가 연결되기 때문에 URI 로 전달된다.</p>
<pre class="z-code"><code><span class="z-text z-plain"># packet header in 3 step
</span><span class="z-text z-plain">3e:53:50:ac:00:d4 &gt; ee:ee:ee:ee:ee:ee,
</span><span class="z-text z-plain">10.69.11.36.60157 &gt; 10.69.149.2.15008: ...
</span></code></pre>
<p>4번은 프록시 파드에서 패킷이 수신되는 단계이다. 프록시는 패킷의 출발지 주소(10.69.11.36)와 URI 로 전달받은 원래의 목적지 주소(172.16.52.69:80)를 이용하여 필요한 정책을 수행한 다음 목적지 파드(nginx)를 결정한다.</p>
<pre class="z-code"><code><span class="z-text z-plain"># packet header in 4 step
</span><span class="z-text z-plain">ee:ee:ee:ee:ee:ee &gt; 0a:20:6d:71:01:f7,
</span><span class="z-text z-plain">10.69.11.36.60157 &gt; 10.69.149.2.15008: ...
</span></code></pre>
<p>5번은 프록시 파드에서 패킷이 송신되는 단계이다. 전달받은 패킷을 목적지 파드(nginx)의 주소(10.88.135.163)로 전달하지만, 목적지 파드의 노드(node2)에 있는 터널링 파드가 패킷을 가로채기 때문에 패킷의 목적지 포트는 Ztunnel 의 인바운드 포트(15008)를 사용한다. 그리고 3번과 마찬가지로 Ztunnel 과 프록시(Waypoint)는 HBONE 프로토콜로 연결되기 때문에 원래의 목적지 주소(10.88.135.163:80)는 URI 로 전달된다.</p>
<pre class="z-code"><code><span class="z-text z-plain"># packet header in 5 step
</span><span class="z-text z-plain">0a:20:6d:71:01:f7 &gt; ee:ee:ee:ee:ee:ee,
</span><span class="z-text z-plain">10.69.149.2.59990 &gt; 10.88.135.163.15008: ...
</span></code></pre>
<p>목적지 파드의 호스트 네트워크 장치(veth4)로 수신된 패킷은 egress BPF 프로그램(C)에서 패킷의 목적지 물리주소를 터널링 파드(ztunnel2)의 네트워크 장치(eth5)의 물리주소(ce:7f:ba:06:21:08)로 수정한 다음, 강제로 터널링 파드의 호스트 네트워크 장치(veth5)로 전달한다. 그리고 호스트 네트워크 장치(veth5)로 전달된 패킷은 VETH 로 연결된 네트워크 장치(eth5)로 전달된다.</p>
<p>6번은 터널링 파드에서 패킷이 수신되는 단계이다. 수신된 패킷은 네트워크 장치(eth5)의 ingress BPF 프로그램(D)에서 강제로 Ztunnel 이 인바운드 포트(15008)로 대기(listen)하고 있는 소켓으로 전달된다.</p>
<pre class="z-code"><code><span class="z-text z-plain"># packet header in 6 step
</span><span class="z-text z-plain">ee:ee:ee:ee:ee:ee &gt; ce:7f:ba:06:21:08,
</span><span class="z-text z-plain">10.69.149.2.59990 &gt; 10.88.135.163.15008: ...
</span></code></pre>
<p>7번은 터널링 파드에서 패킷이 송신되는 단계이다. 프록시에서 URI 로 전달받은 원래의 목적지 주소(10.88.135.163:80)로 패킷을 전달한다. 3번과 마찬가지로, 패킷의 출발지 주소는 터널링 파드의 주소가 아닌 전달받은 패킷의 출발지 주소(10.69.149.2)를 그대로 사용한다.</p>
<pre class="z-code"><code><span class="z-text z-plain"># packet header in 7 step
</span><span class="z-text z-plain">ce:7f:ba:06:21:08 &gt; ee:ee:ee:ee:ee:ee,
</span><span class="z-text z-plain">10.69.149.2.34621 &gt; 10.88.135.163.80: ...
</span></code></pre>
<p>터널링 파드의 호스트 네트워크 장치(veth5)로 수신된 패킷은 ingress BPF 프로그램(E)에서 패킷의 목적지 물리주소를 목적지 파드(nginx)의 네트워크 장치(eth4)의 물리주소(ba:02:f4:c8:98:77)로 수정한 다음, 강제로 목적지 파드의 호스트 네트워크 장치(veth4)로 전달한다. 여기서 중요한 점은 호스트 네트워크 장치(veth4)로 수신된 패킷이 다시 터널링 파드로 전달되는 것을 막기 위해 패킷에 정해진 표시(BYPASS)를 해야한다는 것이다. 호스트 네트워크 장치(veth4)의 egress BPF 프로그램(C)이 정해진 표시(BYPASS)가 있는 패킷은 터널링 파드로 전달하지 않기 때문이다. 그래서 목적지 파드의 호스트 네트워크 장치(veth4)로 수신된 패킷은 터널링 파드로 전달되지 않고 VETH 로 연결된 네트워크 장치(eth4)로 전달된다.</p>
<p>8번은 목적지 파드에서 패킷이 수신되는 단계이다. 아직은 프록시(Waypoint)가 투명하게 동작하지 않기 때문에 원래의 출발지 주소가 아닌 프록시의 주소로 전달된다.</p>
<pre class="z-code"><code><span class="z-text z-plain"># packet header in 8 step
</span><span class="z-text z-plain">ce:7f:ba:06:21:08 &gt; ba:02:f4:c8:98:77,
</span><span class="z-text z-plain">10.69.149.2.34621 &gt; 10.88.135.163.80: ...
</span></code></pre>
<p>지금까지 AmbientMesh 의 동작 과정에 대해 살펴보았고, 아직 초기 개발 단계이기 때문에 앞으로 많은 부분이 변경되거나 개선될 수 있다. eBPF 를 이용하여 패킷의 흐름을 제어하는 것들(Cilium, ...)은 대부분 유사한 방식으로 동작하기 때문에, 위의 내용을 정확히 이해하면 CNI 의 동작 과정을 이해하는데도 많은 도움이 될 것이다.</p>

      <nav>
        <div>
          <a href="https://haruband.github.io/k8s-istio-ambientmesh-rpfilter/">&#8249; [K8S&#x2F;Istio] AmbientMesh RPFilter 문제 분석</a>
        </div>
        <div>
          <a href="https://haruband.github.io/k8s-istio-ambientmesh/"> [K8S&#x2F;Istio] AmbientMesh 소개 &#8250;</a>
        </div>
      </nav>
    </article>

    <div class="sblock">
      <div class="blockdiv">
        <a class="b s150" href="https://haruband.github.io/tags/istio/">Series</a><br>
            
      <a href="https://haruband.github.io/k8s-istio-ambientmesh/">[K8S&#x2F;Istio] AmbientMesh 소개</a><br>
            
      <a class="scur" href="https://haruband.github.io/k8s-istio-ambientmesh-flow/">[K8S&#x2F;Istio] AmbientMesh 동작 과정 분석</a><br>
    
            
      <a href="https://haruband.github.io/k8s-istio-ambientmesh-rpfilter/">[K8S&#x2F;Istio] AmbientMesh RPFilter 문제 분석</a><br>
            
      <a href="https://haruband.github.io/k8s-istio-ambientmesh-cilium/">[K8S&#x2F;Istio] AmbientMesh Cilium 문제 분석</a><br>
      </div>
  </main>
  <footer>
    <div class="c">
      <nav class="tpad"><div><a href="https://www.linkedin.com/in/inhyeok-kim-7620a0b0/" target="_blank" title="LinkedIn"><i type="Button" class="svg linkedin" title="LinkedIn"></i></a><a href="https://github.com/haruband/" target="_blank" title="Github"><i type="Button" class="svg github" title="Github"></i></a></div></nav>
      <nav class="vpad">
        <a class="rpad s90" href="https://haruband.github.io/about/"> About </a>
        <a class="rpad s90" href="https://haruband.github.io/contact/"> Contact </a>
      </nav>
      <p class="s80"> &copy; <span id="year">2025</span> CodeBook</p>
      <p class="s80">Powered by <a href="https://www.getzola.org/" target="_blank">Zola</a> & <a href="https://github.com/jieiku/abridge/" target="_blank">Abridge</a></p>
    </div>
  </footer><span class="topout">
<span class="topleft"> </span><a href="#" class="top" title="Back to Top"><i class="svgs svgh angu"></i></a>
</span>
</body>
</html>

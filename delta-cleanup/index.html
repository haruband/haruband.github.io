
<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://haruband.github.io/js/theme.min.js" integrity="sha384-pb++s6uBRKaQv+iAXpgA/H3IlpLZdO14tTwuCI7uXmz4aaZdByoCcM+6BhynMq/1"></script>
  <link rel="stylesheet" href="https://haruband.github.io/abridge.css?h=98ebdf6fd3d59dfb2edf" />
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="base" content="https://haruband.github.io" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#333333" />
  <meta name="msapplication-TileColor" content="#333333" />
  <link rel="manifest" href="https://haruband.github.io/manifest.min.json" />
  <link rel="mask-icon" href="https://haruband.github.io/safari-pinned-tab.svg" color="#ff9900" />
  <link rel="icon" type="image/svg+xml" href="https://haruband.github.io/favicon.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://haruband.github.io/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://haruband.github.io/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://haruband.github.io/favicon-16x16.png" />
  <link rel="alternate" type="application/atom+xml" title="CodeBook Atom Feed" href="https://haruband.github.io/atom.xml" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <title>[Delta] 델타로그 CleanUp 문제 분석 | CodeBook</title>
  <meta name="author" content="Inhyeok Kim" />
  <meta name="copyright" content="CodeBook" />
  <meta name="description" content="Haruband&#x27;s TechBlog" />
  <link rel="canonical" href="https://haruband.github.io/delta-cleanup/" />
  <meta name="keywords" content="Arrow, Datafusion, Kubernetes" />
  <meta name="google-site-verification" content="Your Google Site verification code." />
  <meta name="msvalidate.01" content="Your Bing Site verification code." />
  <meta property="og:url" content="https://haruband.github.io/delta-cleanup/" />
  <meta name="twitter:url" content="https://haruband.github.io/delta-cleanup/" />
  <meta property="og:description" content="Haruband&#x27;s TechBlog" />
  <meta name="twitter:description" content="Haruband&#x27;s TechBlog" />
  <meta property="og:title" content="[Delta] 델타로그 CleanUp 문제 분석 | CodeBook" />
  <meta name="twitter:title" content="[Delta] 델타로그 CleanUp 문제 분석 | CodeBook" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://haruband.github.io/banner.png" />
  <meta property="og:image" content="https://haruband.github.io/banner.png" />
  <meta property="og:site_name" content="CodeBook" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:type" content="website" />
  <meta property="og:updated_time" content="2022-01-25" />
  <meta name="twitter:site" content="@your-user-name" />
  <meta name="twitter:creator" content="@your-user-name" />
  <script defer src="https://haruband.github.io/js/abridge.min.js?h=e0f9a881a665c86cce9c" integrity="sha384-QF67y7RnPkuDrJNQqn3/7nYxqxWkW/qHI7zN0WTES1aXbf+TotoByRBb835fUE6U"></script>
  <noscript><link rel="stylesheet" href="https://haruband.github.io/nojs.css" /></noscript>
</head>
<body>
  <header>
    <nav>
      <div><big><a href="https://haruband.github.io" title="CodeBook">CodeBook</a></big></div>
      <div>

        <div>
          <ul><li><a class="s110" href="https://haruband.github.io/archive/"> Posts </a></li><li><a class="s110" href="https://haruband.github.io/tags/"> Tags </a></li><li><i type="reset" id="mode" class="js svgs adjust"></i></ul>
        </div>

        <div>
          <div>
            <form autocomplete=off class="js" name="goSearch" id="searchbox">
              <div class="searchd">
                <input id="searchinput" type="text" placeholder="Search" title="Search" />
                <button type="submit" title="Search" class="svgs svgm search"></button>
              </div>
              <div class="results"><div id="suggestions"></div></div>
            </form>
          </div>
        </div>

      </div>
    </nav>
  </header>
  <main>
    <article>
      <h1><a href="https://haruband.github.io/delta-cleanup/">[Delta] 델타로그 CleanUp 문제 분석</a></h1>

      <span class="s95"> Inhyeok Kim <span class="rpad"></span> January 25, 2022 <span class="rpad"></span>Updated: January 25, 2022 <span class="rpad"></span> #<a href="https://haruband.github.io/tags/delta/">Delta</a> </span>

    
        <div class="block">
      <div class="blockdiv">
        <a class="b s150" href="https://haruband.github.io/tags/delta/">Delta (Series)</a><br>
            <a href="https://haruband.github.io/delta-overview/">[Delta] 델타로그 분석</a><br>
            <a href="https://haruband.github.io/delta-optimize/">[Delta] 델타로그 최적화</a><br>
            <a href="https://haruband.github.io/delta-filtering/">[Delta] 읽기 성능 최적화</a><br>
            <a href="https://haruband.github.io/delta-checkpoints/">[Delta] 델타로그 체크포인트 분석</a><br>
            <a class="scur" href="https://haruband.github.io/delta-cleanup/">[Delta] 델타로그 CleanUp 문제 분석</a><br> 
          
      </div>
    </div>


<p>최근 스파크를 이용하여 스트리밍 데이터를 델타레이크로 저장할 때 발생한 문제를 소개하고자 한다. 현재 작업 중인 환경에서는 스파크 스트리밍의 마이크로 배치 처리시간이 평균적으로 일반적인 쓰기 작업은 10 초 내외이고, 10 번의 쓰기 작업마다 새로운 체크포인트 파일을 만들 때는 2~30 초 정도이다. 그런데 주기적으로 새로운 체크포인트 파일을 만들 때 400 초 정도의 시간이 소요되는 문제를 발견하였다. 오늘은 왜 이런 문제가 발생하였는지 살펴보도록 하자.</p>
<p><img src="https://haruband.github.io/delta-cleanup/./batchduration.png" alt="batchduration.png" /></p>
<p>위의 그래프는 문제 발생 시 배치 처리시간을 보여주고 있다. 보시는 바와 같이 오전 9 시 15 분쯤 배치 처리시간이 400 초를 넘어서는 것을 볼 수 있다. 그리고 지난 며칠 간의 데이터를 분석해보니, 매일 같은 시간에 같은 문제가 반복되고 있는 것을 알 수 있었다.</p>
<p><img src="https://haruband.github.io/delta-cleanup/./executortasktime.png" alt="executortasktime.png" /></p>
<p>위의 그래프는 해당 문제가 발생했을 때 스파크 스트리밍에 사용된 익스큐터(Executor)의 태스크 처리 시간을 보여주고 있다. 현재는 2 개의 익스큐터를 사용 중인데, 해당 시간에만 2 개의 익스큐터 모두 아무런 작업을 하지 않은 것을 볼 수 있다. 이를 통해 스파크 스트리밍에 사용된 드라이버에서 반복적으로 해당 시간에 문제가 발생하고 있다고 예상할 수 있다.
(어떤 문제가 규칙성을 보이면, 가비지 컬렉션(Gabage Collection) 혹은 어떠한 자원 경쟁에 의한 문제는 아니라고 볼 수 있다.)</p>
<p>그래서 문제가 발생했을 때의 상황을 이해하기 위해 드라이버의 콘솔 로그를 분석하였고, 결과적으로 아래와 같이 문제의 원인을 파악할 수 있었다. 아래 로그를 보면, 드라이버가 어떠한 작업을 처리하기 위해 400 초 정도의 시간을 보낸 것을 알 수 있다. 이로 인해 다음 마이크로 배치 처리가 지연되면서 모든 익스큐터가 대기 상태가 된 것이다.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">09:08:31.398</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>INFO<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> DeltaLog: Starting the deletion of log files older than 30 Oct 2022 00:00:00 GMT</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">09:14:53.866</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>INFO<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> DeltaLog: Deleted 4242 log files older than 30 Oct 2022 00:00:00 GMT</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span>
</span></code></pre>
<p>그럼 이제 정확히 어떤 작업으로 인해 이러한 문제가 발생했는지 좀 더 알아보도록 하자.</p>
<p>위의 작업은 델타레이크에서 보관 기간(logRetentionDuration)이 지난 로그 파일을 지우는 것이다. 해당 작업은 매일 UTC 기준으로 0 시에 실행되고, 그래서 한국시간(UTC+9)으로 오전 9 시쯤 실행되었다. 정확히는 UTC 기준으로 0 시가 지나고 처음 체크포인트 파일을 만들 때 해당 작업이 실행된다. 현재 작업 환경에서는 마이크로 배치 간격이 1 분이기 때문에 하루에 생성되는 로그의 개수는 1440 개 정도이고, 체크포인트 파일도 같은 방식으로 지워지기 때문에 해당 작업에서 지워지는 파일의 수는 대략 2 천개 정도이다. 즉, 드라이버에서 오브젝트 스토리지에 저장되어 있는 2 천개의 파일을 지우기 위해 대략 400 초 정도의 시간을 소요한 것이다.</p>
<p>지금까지 주기적으로 보관 기간이 지난 로그 파일을 지울 때 발생하는 문제를 살펴보았다. 쓰기 작업이 많은 서비스일수록 지워야하는 로그 파일이 많아져서 지연 시간이 길어질 수 있으니 여러 가지 개선할 수 있는 방법에 대한 고민이 필요하다.</p>

      <nav>
        <div>
          <a href="https://haruband.github.io/k8s-istio-ambientmesh/">&#8249; [K8S&#x2F;Istio] AmbientMesh 소개</a>
        </div>
        <div>
          <a href="https://haruband.github.io/delta-checkpoints/"> [Delta] 델타로그 체크포인트 분석 &#8250;</a>
        </div>
      </nav>
    </article>

    <div class="sblock">
      <div class="blockdiv">
        <a class="b s150" href="https://haruband.github.io/tags/delta/">Series</a><br>
            
      <a href="https://haruband.github.io/delta-overview/">[Delta] 델타로그 분석</a><br>
            
      <a href="https://haruband.github.io/delta-optimize/">[Delta] 델타로그 최적화</a><br>
            
      <a href="https://haruband.github.io/delta-filtering/">[Delta] 읽기 성능 최적화</a><br>
            
      <a href="https://haruband.github.io/delta-checkpoints/">[Delta] 델타로그 체크포인트 분석</a><br>
            
      <a class="scur" href="https://haruband.github.io/delta-cleanup/">[Delta] 델타로그 CleanUp 문제 분석</a><br>
    
      </div>
  </main>
  <footer>
    <div class="c">
      <nav class="tpad"><div><a href="https://www.linkedin.com/in/inhyeok-kim-7620a0b0/" target="_blank" title="LinkedIn"><i type="Button" class="svg linkedin" title="LinkedIn"></i></a><a href="https://github.com/haruband/" target="_blank" title="Github"><i type="Button" class="svg github" title="Github"></i></a></div></nav>
      <nav class="vpad">
        <a class="rpad s90" href="https://haruband.github.io/about/"> About </a>
        <a class="rpad s90" href="https://haruband.github.io/contact/"> Contact </a>
      </nav>
      <p class="s80"> &copy; <span id="year">2025</span> CodeBook</p>
      <p class="s80">Powered by <a href="https://www.getzola.org/" target="_blank">Zola</a> & <a href="https://github.com/jieiku/abridge/" target="_blank">Abridge</a></p>
    </div>
  </footer>
</body>
</html>

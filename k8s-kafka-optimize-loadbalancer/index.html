
<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://haruband.github.io/js/theme.min.js" integrity="sha384-pb++s6uBRKaQv+iAXpgA/H3IlpLZdO14tTwuCI7uXmz4aaZdByoCcM+6BhynMq/1"></script>
  <link rel="stylesheet" href="https://haruband.github.io/abridge.css?h=98ebdf6fd3d59dfb2edf" />
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="base" content="https://haruband.github.io" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#333333" />
  <meta name="msapplication-TileColor" content="#333333" />
  <link rel="manifest" href="https://haruband.github.io/manifest.min.json" />
  <link rel="mask-icon" href="https://haruband.github.io/safari-pinned-tab.svg" color="#ff9900" />
  <link rel="icon" type="image/svg+xml" href="https://haruband.github.io/favicon.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://haruband.github.io/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://haruband.github.io/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://haruband.github.io/favicon-16x16.png" />
  <link rel="alternate" type="application/atom+xml" title="CodeBook Atom Feed" href="https://haruband.github.io/atom.xml" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <title>[K8S] 네트워크 최적화 (MetalLB) | CodeBook</title>
  <meta name="author" content="Inhyeok Kim" />
  <meta name="copyright" content="CodeBook" />
  <meta name="description" content="Haruband&#x27;s TechBlog" />
  <link rel="canonical" href="https://haruband.github.io/k8s-kafka-optimize-loadbalancer/" />
  <meta name="keywords" content="Arrow, Datafusion, Kubernetes" />
  <meta name="google-site-verification" content="Your Google Site verification code." />
  <meta name="msvalidate.01" content="Your Bing Site verification code." />
  <meta property="og:url" content="https://haruband.github.io/k8s-kafka-optimize-loadbalancer/" />
  <meta name="twitter:url" content="https://haruband.github.io/k8s-kafka-optimize-loadbalancer/" />
  <meta property="og:description" content="Haruband&#x27;s TechBlog" />
  <meta name="twitter:description" content="Haruband&#x27;s TechBlog" />
  <meta property="og:title" content="[K8S] 네트워크 최적화 (MetalLB) | CodeBook" />
  <meta name="twitter:title" content="[K8S] 네트워크 최적화 (MetalLB) | CodeBook" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://haruband.github.io/banner.png" />
  <meta property="og:image" content="https://haruband.github.io/banner.png" />
  <meta property="og:site_name" content="CodeBook" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:type" content="website" />
  <meta property="og:updated_time" content="2021-03-19" />
  <meta name="twitter:site" content="@your-user-name" />
  <meta name="twitter:creator" content="@your-user-name" />
  <script defer src="https://haruband.github.io/js/abridge.min.js?h=e0f9a881a665c86cce9c" integrity="sha384-QF67y7RnPkuDrJNQqn3/7nYxqxWkW/qHI7zN0WTES1aXbf+TotoByRBb835fUE6U"></script>
  <noscript><link rel="stylesheet" href="https://haruband.github.io/nojs.css" /></noscript>
</head>
<body>
  <header>
    <nav>
      <div><big><a href="https://haruband.github.io" title="CodeBook">CodeBook</a></big></div>
      <div>

        <div>
          <ul><li><a class="s110" href="https://haruband.github.io/archive/"> Posts </a></li><li><a class="s110" href="https://haruband.github.io/tags/"> Tags </a></li><li><i type="reset" id="mode" class="js svgs adjust"></i></ul>
        </div>

        <div>
          <div>
            <form autocomplete=off class="js" name="goSearch" id="searchbox">
              <div class="searchd">
                <input id="searchinput" type="text" placeholder="Search" title="Search" />
                <button type="submit" title="Search" class="svgs svgm search"></button>
              </div>
              <div class="results"><div id="suggestions"></div></div>
            </form>
          </div>
        </div>

      </div>
    </nav>
  </header>
  <main>
    <article>
      <h1><a href="https://haruband.github.io/k8s-kafka-optimize-loadbalancer/">[K8S] 네트워크 최적화 (MetalLB)</a></h1>

      <span class="s95"> Inhyeok Kim <span class="rpad"></span> March 19, 2021 <span class="rpad"></span>Updated: March 19, 2021 <span class="rpad"></span> #<a href="https://haruband.github.io/tags/k8s/">K8S</a>  #<a href="https://haruband.github.io/tags/kubernetes/">Kubernetes</a>  #<a href="https://haruband.github.io/tags/cilium/">Cilium</a>  #<a href="https://haruband.github.io/tags/metallb/">MetalLB</a> </span>

    
        <div class="block">
      <div class="blockdiv">
        <a class="b s150" href="https://haruband.github.io/tags/k8s/">K8S (Series)</a><br>
            <a href="https://haruband.github.io/k8s-cni-vxlan/">[K8S&#x2F;Cilium] VXLAN 기반 Tunneling Datapath 기법</a><br>
            <a href="https://haruband.github.io/k8s-cni-ipvlan/">[K8S&#x2F;Cilium] IPVLAN 기반 Routing Datapath 기법</a><br>
            <a href="https://haruband.github.io/k8s-cni-service/">[K8S&#x2F;Cilium] ClusterIP 서비스</a><br>
            <a href="https://haruband.github.io/k8s-cni-nodeport/">[K8S&#x2F;Cilium] NodePort 서비스</a><br>
            <a href="https://haruband.github.io/k8s-cni-dsr/">[K8S&#x2F;Cilium] DSR (Direct Server Return)</a><br>
            <a href="https://haruband.github.io/k8s-cni-redirect/">[K8S&#x2F;Cilium] bpf_redirect_peer()&#x2F;bpf_redirect_neigh()</a><br>
            <a href="https://haruband.github.io/k8s-cni-routing-benchmark/">[K8S&#x2F;Cilium] 라우팅 기법 성능 평가</a><br>
            <a href="https://haruband.github.io/k8s-cni-ipvlan-redirect-bug/">[K8S&#x2F;Cilium] IPVLAN 기반 Cilium 의 NodePort 버그 분석</a><br>
            <a href="https://haruband.github.io/k8s-cni-loadbalancing/">[K8S&#x2F;Cilium] Socket-Based LoadBalancing 기법</a><br>
            <a href="https://haruband.github.io/k8s-cni-servicemesh-proxy/">[K8S&#x2F;Cilium] eBPF 기반 서비스 메쉬 분석 (Per-Node Proxy)</a><br>
            <a href="https://haruband.github.io/k8s-vxlan-forbidden/">[K8S] VXLAN 사용 불가 문제 분석</a><br>
            <a href="https://haruband.github.io/k8s-nat-loopback-snat/">[K8S] NAT 루프백 문제 분석 (SNAT)</a><br>
            <a class="scur" href="https://haruband.github.io/k8s-kafka-optimize-loadbalancer/">[K8S] 네트워크 최적화 (MetalLB)</a><br> 
          
            <a href="https://haruband.github.io/k8s-proxy-bypass/">[K8S] Cilium Socket-based LoadBalancing 에 의한 Istio Envoy 우회 문제 분석</a><br>
            <a href="https://haruband.github.io/k8s-memory-swap/">[K8S] 메모리 스와핑 지원 분석</a><br>
            <a href="https://haruband.github.io/k8s-nat-loopback-lrp/">[K8S] NAT 루프백 문제 분석 (LRP)</a><br>
            <a href="https://haruband.github.io/k8s-cgroupv2-privatens/">[K8S] Cilium CGroupV2&#x2F;PrivateNS 문제 분석</a><br>
            <a href="https://haruband.github.io/k8s-rpfilter/">[K8S] Cilium RPFilter 문제 분석</a><br>
            <a href="https://haruband.github.io/k8s-qos-memory/">[K8S] 메모리 QoS 지원 분석</a><br>
            <a href="https://haruband.github.io/k8s-networkpolicy/">[K8S] Cilium NetworkPolicy 문제 분석</a><br>
            <a href="https://haruband.github.io/k8s-spark-optimize/">[K8S&#x2F;Spark] 성능 최적화</a><br>
            <a href="https://haruband.github.io/k8s-spark-optimize-swap/">[K8S&#x2F;Spark] 메모리 최적화 (Swap)</a><br>
            <a href="https://haruband.github.io/k8s-istio-ambientmesh/">[K8S&#x2F;Istio] AmbientMesh 소개</a><br>
            <a href="https://haruband.github.io/k8s-istio-ambientmesh-flow/">[K8S&#x2F;Istio] AmbientMesh 동작 과정 분석</a><br>
            <a href="https://haruband.github.io/k8s-istio-ambientmesh-rpfilter/">[K8S&#x2F;Istio] AmbientMesh RPFilter 문제 분석</a><br>
            <a href="https://haruband.github.io/k8s-istio-ambientmesh-cilium/">[K8S&#x2F;Istio] AmbientMesh Cilium 문제 분석</a><br>
      </div>
    </div>


<p>쿠버네티스(K8S)를 지원하는 대표적인 오픈소스 로드밸런서(LoadBalancer)인 <a rel="noopener" target="_blank" href="https://metallb.universe.tf/">MetalLB</a> 를 이용하여 카프카(Kafka)의 네트워크 성능을 개선한 사례를 공유하고자 한다. 우리는 <a rel="noopener" target="_blank" href="https://strimzi.io/">StrimziOperator</a> 를 이용하여 카프카를 배포/운영하고 있으며, 초기에는 간단히 노드포트(NodePort)를 이용하여 부트스트랩(Bootstrap)과 브로커(Broker)에 접속했기 때문에 불필요한 네트워크 홉(Hop)이 추가되는 문제가 발생하였다. 우선, 간단히 노드포트가 어떻게 동작하기에 이런 문제가 생긴 것인지 알아보도록 하자.</p>
<p><img src="https://haruband.github.io/k8s-kafka-optimize-loadbalancer/./cilium-nodeport.png" alt="cilium.nodeport" /></p>
<p>위의 그림은 클라이언트가 노드포트를 이용하여 서비스에 접근하는 과정이다. 클라이언트는 해당 서비스의 엔드포인트(Pod3)가 어느 노드에 있는지 알 수 없기 때문에 임의의 노드(위에서는 Node0)로 접속한다. 위의 경우에는 엔드포인트가 Node1 에 있었기 때문에, Node0 에서 SNAT(SourceNAT) 를 이용하여 Node1 로 요청 메세지를 송신하고 응답 메세지를 수신한 다음 클라이언트에게 전달한다. (부트스트랩이 전달해준 브로커의 주소도 노드포트 주소였기 때문에 실제 브로커 파드가 위치한 노드의 주소가 아닐 수 있다.) 이는 클라이언트가 처음부터 엔드포인트가 있는 노드(Node1)로 바로 접속했으면 발생하지 않았을 문제이고, 이 문제를 해결하기 위해 쿠버네티스가 제공하는 기능이 로드밸런서이다.</p>
<p>지금부터 MetalLB 를 이용하여 어떻게 이 문제를 해결하였는지 소개하겠다. MetalLB 는 L2 모드와 BGP 모드를 지원하기 때문에 각각 어떻게 동작하는지, 어떤 장단점이 있는지도 같이 살펴보도록 하자.</p>
<p>다음은 검증에 사용된 노드의 주소(IP/MAC)이다.</p>
<ul>
<li>Node0 : 192.168.200.200 (f4:6b:8c:82:42:33)</li>
<li>Node1 : 192.168.200.201 (f4:6b:8c:82:42:2b)</li>
<li>Node2 : 192.168.200.202 (f4:6b:8c:82:41:f8)</li>
</ul>
<p>아래는 부트스트랩과 브로커의 서비스 목록이다. 모두 로드밸런서로 설정되어 있기 때문에 할당된 외부 주소(ExternalIP)를 확인할 수 있다. (해당 리스너의 광고(Advertised) 주소는 아래 외부 주소로 설정되어있다.)</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> kubectl get services<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>n</span> kafka</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">NAME</span></span><span class="z-meta z-function-call z-arguments z-shell">              TYPE           CLUSTER-IP       EXTERNAL-IP       PORT(S</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">kafka-0</span></span><span class="z-meta z-function-call z-arguments z-shell">           LoadBalancer   172.16.13.97     192.168.200.241   9096:30793/TCP</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">kafka-1</span></span><span class="z-meta z-function-call z-arguments z-shell">           LoadBalancer   172.16.102.197   192.168.200.242   9096:30956/TCP</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">kafka-2</span></span><span class="z-meta z-function-call z-arguments z-shell">           LoadBalancer   172.16.72.116    192.168.200.243   9096:30991/TCP</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">kafka-bootstrap</span></span><span class="z-meta z-function-call z-arguments z-shell">   LoadBalancer   172.16.56.188    192.168.200.240   9096:31023/TCP</span>
</span></code></pre>
<p>그리고 브로커의 파드 목록이다. 각각 어느 노드에 있는지 확인할 수 있다.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> kubectl get pods<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>n</span> kafka<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>o</span> wide</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">NAME</span></span><span class="z-meta z-function-call z-arguments z-shell">              READY   STATUS    IP           NODE</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">kafka-0</span></span><span class="z-meta z-function-call z-arguments z-shell">           1/1     Running   10.0.2.233   node1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">kafka-1</span></span><span class="z-meta z-function-call z-arguments z-shell">           1/1     Running   10.0.0.74    node2</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">kafka-2</span></span><span class="z-meta z-function-call z-arguments z-shell">           1/1     Running   10.0.1.189   node0</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span>
</span></code></pre>
<h2 id="metallb-l2-modeu-giban-rodeubaelreonsing">MetalLB L2 모드 기반 로드밸런싱</h2>
<p>L2 모드는 MetalLB 가 데몬셋으로 설치하는 스피커(Speaker)가 외부 주소(IP)에 대한 ARP 요청에 응답하는 방식이다. 간단하게 사용할 수 있지만, 서비스의 엔드포인트가 2 개 이상의 노드에 있는 경우에는 하나의 노드만 요청을 받을 수 있는 문제가 있다. 예를 들어, Node0 과 Node1 에 엔드포인트가 동시에 존재하는 경우, MetalLB 는 임의로 리더를 선출하고, 리더로 선출된 노드의 스피커가 ARP 요청에 응답한다. 결국 해당 외부 주소로는 리더로 선출된 노드에만 접근할 수 있게 된다.</p>
<p>아래는 0번 브로커에 있는 토픽/파티션에 접근하는 클라이언트의 접속 정보이다. 부트스트랩으로부터 필요한 메타데이터를 가져와서 0번 브로커의 외부 주소(192.168.200.241)로 접속하는걸 볼 수 있다.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">INFO:kafka.conn:</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BrokerConnection node_id=0 host=192.168.200.241:9096 <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>connecting<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>IPv4 (<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>192.168.200.241<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, 9096)<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span><span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span>: connecting to 192.168.200.241:9096 <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>(<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>192.168.200.241<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, 9096) IPv4<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
</span></code></pre>
<p>그렇다면 실제로 어떤 노드로 접속했을까? 아래는 클라이언트의 ARP 캐시 목록이다.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> arp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>a</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">?</span></span><span class="z-meta z-function-call z-arguments z-shell"> (192.168.200.241</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">at</span></span><span class="z-meta z-function-call z-arguments z-shell"> f4:6b:8c:82:42:33 <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>ether<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> on enp1s0</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span>
</span></code></pre>
<p>그런데 위의 물리 주소(MAC)는 0번 브로커가 있는 Node1 의 물리 주소(f4:6b:8c:82:42:2b)가 아니고, Node0 의 물리 주소(f4:6b:8c:82:42:33)이다. 왜 이런 일이 발생했을까? 이유는 외부 트래픽 정책(ExternalTrafficPolicy)이 클러스터(Cluster)로 되어있기 때문이다. 해당 정책은 외부에서 접속했을 때 다른 노드에 있는 파드에 대한 접근을 허용하기 때문에 MetalLB 는 임의의 노드를 리더로 선출한다. 그래서 외부 트래픽 정책을 다른 노드에 있는 파드에 대한 접근을 허용하지 않는 로컬(Local)로 설정하면 아래와 같이 0번 브로커가 있는 Node1 로만 접속하게 된다.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> arp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>a</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">?</span></span><span class="z-meta z-function-call z-arguments z-shell"> (192.168.200.241</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">at</span></span><span class="z-meta z-function-call z-arguments z-shell"> f4:6b:8c:82:42:2b <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>ether<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> on enp1s0</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span>
</span></code></pre>
<p>이제 Node1 로 들어온 요청 메세지를 어떻게 0번 브로커 파드로 전달하는지 살펴보자. 아래는 Node1 의 서비스 목록(Cilium)이다. 외부 주소로 들어온 요청을 0번 브로커 주소(10.0.2.233)로 전달하는 것을 확인할 수 있다. (eBPF 프로그램(Cilium)에서 DNAT(DestinationNAT) 를 이용하여 메세지를 전달한다.)</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">node1</span></span><span class="z-meta z-function-call z-arguments z-shell"> $ cilium service list</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ID</span></span><span class="z-meta z-function-call z-arguments z-shell">     Frontend                  Service Type   Backend</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2174</span></span><span class="z-meta z-function-call z-arguments z-shell">   192.168.200.241:9096      LoadBalancer   1 =<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-file-descriptor z-shell">10</span>.0.2.233:9096 (active</span><span class="z-meta z-function-call z-shell"></span>)
</span></code></pre>
<p>참고로 Node0 의 서비스 목록(Cilium)을 살펴보면, 0번 브로커의 외부 주소에 대한 백엔드가 비어있는 것을 볼 수 있다. 이는 앞에서 외부 트래픽 정책을 로컬로 설정해서 다른 노드에 있는 파드는 백엔드 목록에서 제거되기 때문이다.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">node0</span></span><span class="z-meta z-function-call z-arguments z-shell"> $ cilium service list</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ID</span></span><span class="z-meta z-function-call z-arguments z-shell">     Frontend                  Service Type   Backend</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2175</span></span><span class="z-meta z-function-call z-arguments z-shell">   192.168.200.241:9096      LoadBalancer</span>
</span></code></pre>
<h2 id="metallb-bgp-modeu-giban-rodeubaelreonsing">MetalLB BGP 모드 기반 로드밸런싱</h2>
<p>BGP 모드는 MetalLB 가 데몬셋으로 설치하는 스피커가 BGP 피어(Peer)로 동작하면서 라우팅 정보를 갱신하는 방식이다. BGP 를 지원하는 라우터가 있어야만 사용할 수 있는 방식이지만, 서비스의 엔드포인트가 2 개 이상의 노드에 있는 경우에도 라우터가 지원하는 로드밸런싱 기능을 이용하여 트래픽을 분산 처리할 수 있다.</p>
<p>오픈소스 라우팅 데몬인 <a rel="noopener" target="_blank" href="https://bird.network.cz/">BIRD</a> 를 이용하여 MetalLB 의 BGP 모드를 간단히 검증하였다. 아래는 외부 트래픽 정책을 로컬로 설정했을 때 BIRD 가 설치된 노드의 라우팅 테이블이다. 브로커의 외부 주소는 각각 브로커 파드가 동작 중인 노드의 주소로 설정되어 있고, 부트스트랩의 외부 주소는 모든 브로커 파드가 동작 중인 세 개 노드의 주소로 설정되어 있다.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">router</span></span><span class="z-meta z-function-call z-arguments z-shell"> $ ip route</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">192.168.200.240</span></span><span class="z-meta z-function-call z-arguments z-shell"> proto bird metric 32</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.200 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.201 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.202 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">192.168.200.241</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.201 dev eno1 proto bird metric 32</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">192.168.200.242</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.202 dev eno1 proto bird metric 32</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">192.168.200.243</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.200 dev eno1 proto bird metric 32</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span>
</span></code></pre>
<p>아래는 외부 트래픽 정책을 클러스터로 설정했을 때 BIRD 가 설치된 노드의 라우팅 테이블이다. 모든 노드를 통해서 모든 파드로 접속할 수 있기 때문에 모든 외부 주소는 모든 노드의 주소로 설정되어 있는 것을 볼 수 있다.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">router</span></span><span class="z-meta z-function-call z-arguments z-shell"> $ ip route</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">192.168.200.240</span></span><span class="z-meta z-function-call z-arguments z-shell"> proto bird metric 32</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.200 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.201 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.202 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">192.168.200.241</span></span><span class="z-meta z-function-call z-arguments z-shell"> proto bird metric 32</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.200 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.201 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.202 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">192.168.200.242</span></span><span class="z-meta z-function-call z-arguments z-shell"> proto bird metric 32</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.200 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.201 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.202 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">192.168.200.243</span></span><span class="z-meta z-function-call z-arguments z-shell"> proto bird metric 32</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.200 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.201 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash">	<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nexthop</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.200.202 dev eno1 weight 1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span>
</span></code></pre>
<p>그리고 노드로 들어온 요청을 브로커로 전달하는 과정은 앞의 경우와 동일하다.</p>
<p>쿠버네티스와 같은 클러스터 환경에서는 불필요한 네트워크 홉을 줄이는 것이 매우 중요하기 때문에 워크로드의 동작 방식을 정확히 파악하여 적절한 네트워크 정책을 적용하는 것이 중요하다.</p>

      <nav>
        <div>
          <a href="https://haruband.github.io/k8s-proxy-bypass/">&#8249; [K8S] Cilium Socket-based LoadBalancing 에 의한 Istio Envoy 우회 문제 분석</a>
        </div>
        <div>
          <a href="https://haruband.github.io/k8s-nat-loopback-snat/"> [K8S] NAT 루프백 문제 분석 (SNAT) &#8250;</a>
        </div>
      </nav>
    </article>

    <div class="sblock">
      <div class="blockdiv">
        <a class="b s150" href="https://haruband.github.io/tags/k8s/">Series</a><br>

          
          
      <a href="https://haruband.github.io/k8s-cni-vxlan/">[K8S&#x2F;Cilium] VXLAN 기반 Tunneling Datapath 기법</a><br>

          
            <details>
              <summary>More...</summary>
            </details>
            <div class="hidden_li">
                <a href="https://haruband.github.io/k8s-cni-ipvlan/">[K8S&#x2F;Cilium] IPVLAN 기반 Routing Datapath 기법</a><br>
                <a href="https://haruband.github.io/k8s-cni-service/">[K8S&#x2F;Cilium] ClusterIP 서비스</a><br>
                <a href="https://haruband.github.io/k8s-cni-nodeport/">[K8S&#x2F;Cilium] NodePort 서비스</a><br>
                <a href="https://haruband.github.io/k8s-cni-dsr/">[K8S&#x2F;Cilium] DSR (Direct Server Return)</a><br>
                <a href="https://haruband.github.io/k8s-cni-redirect/">[K8S&#x2F;Cilium] bpf_redirect_peer()&#x2F;bpf_redirect_neigh()</a><br>
                <a href="https://haruband.github.io/k8s-cni-routing-benchmark/">[K8S&#x2F;Cilium] 라우팅 기법 성능 평가</a><br>
                <a href="https://haruband.github.io/k8s-cni-ipvlan-redirect-bug/">[K8S&#x2F;Cilium] IPVLAN 기반 Cilium 의 NodePort 버그 분석</a><br>
                <a href="https://haruband.github.io/k8s-cni-loadbalancing/">[K8S&#x2F;Cilium] Socket-Based LoadBalancing 기법</a><br>
                <a href="https://haruband.github.io/k8s-cni-servicemesh-proxy/">[K8S&#x2F;Cilium] eBPF 기반 서비스 메쉬 분석 (Per-Node Proxy)</a><br>
            </div>

          

          
            <a href="https://haruband.github.io/k8s-vxlan-forbidden/">[K8S] VXLAN 사용 불가 문제 분석</a><br>
            <a href="https://haruband.github.io/k8s-nat-loopback-snat/">[K8S] NAT 루프백 문제 분석 (SNAT)</a><br>

          
            
      <a class="scur" href="https://haruband.github.io/k8s-kafka-optimize-loadbalancer/">[K8S] 네트워크 최적화 (MetalLB)</a><br>
    

          
            <a href="https://haruband.github.io/k8s-proxy-bypass/">[K8S] Cilium Socket-based LoadBalancing 에 의한 Istio Envoy 우회 문제 분석</a><br>
          
            <a href="https://haruband.github.io/k8s-memory-swap/">[K8S] 메모리 스와핑 지원 분석</a><br>
          
            <details>
              <summary>More...</summary>
            </details>
            <div class="hidden_li">
                <a href="https://haruband.github.io/k8s-nat-loopback-lrp/">[K8S] NAT 루프백 문제 분석 (LRP)</a><br>
                <a href="https://haruband.github.io/k8s-cgroupv2-privatens/">[K8S] Cilium CGroupV2&#x2F;PrivateNS 문제 분석</a><br>
                <a href="https://haruband.github.io/k8s-rpfilter/">[K8S] Cilium RPFilter 문제 분석</a><br>
                <a href="https://haruband.github.io/k8s-qos-memory/">[K8S] 메모리 QoS 지원 분석</a><br>
                <a href="https://haruband.github.io/k8s-networkpolicy/">[K8S] Cilium NetworkPolicy 문제 분석</a><br>
                <a href="https://haruband.github.io/k8s-spark-optimize/">[K8S&#x2F;Spark] 성능 최적화</a><br>
                <a href="https://haruband.github.io/k8s-spark-optimize-swap/">[K8S&#x2F;Spark] 메모리 최적화 (Swap)</a><br>
                <a href="https://haruband.github.io/k8s-istio-ambientmesh/">[K8S&#x2F;Istio] AmbientMesh 소개</a><br>
                <a href="https://haruband.github.io/k8s-istio-ambientmesh-flow/">[K8S&#x2F;Istio] AmbientMesh 동작 과정 분석</a><br>
                <a href="https://haruband.github.io/k8s-istio-ambientmesh-rpfilter/">[K8S&#x2F;Istio] AmbientMesh RPFilter 문제 분석</a><br>
            </div>
        
      <a href="https://haruband.github.io/k8s-istio-ambientmesh-cilium/">[K8S&#x2F;Istio] AmbientMesh Cilium 문제 분석</a><br>

        
      </div>
      <div class="blockdiv sticky">
        <a class="b s150" href="#">Index</a>
        <div>
          <a href="#metallb-l2-modeu-giban-rodeubaelreonsing">MetalLB L2 모드 기반 로드밸런싱</a>
        </div>
        <div>
          <a href="#metallb-bgp-modeu-giban-rodeubaelreonsing">MetalLB BGP 모드 기반 로드밸런싱</a>
        </div>
      </div>
    </div>
  </main>
  <footer>
    <div class="c">
      <nav class="tpad"><div><a href="https://www.linkedin.com/in/inhyeok-kim-7620a0b0/" target="_blank" title="LinkedIn"><i type="Button" class="svg linkedin" title="LinkedIn"></i></a><a href="https://github.com/haruband/" target="_blank" title="Github"><i type="Button" class="svg github" title="Github"></i></a></div></nav>
      <nav class="vpad">
        <a class="rpad s90" href="https://haruband.github.io/about/"> About </a>
        <a class="rpad s90" href="https://haruband.github.io/contact/"> Contact </a>
      </nav>
      <p class="s80"> &copy; <span id="year">2025</span> CodeBook</p>
      <p class="s80">Powered by <a href="https://www.getzola.org/" target="_blank">Zola</a> & <a href="https://github.com/jieiku/abridge/" target="_blank">Abridge</a></p>
    </div>
  </footer><span class="topout">
<span class="topleft"> </span><a href="#" class="top" title="Back to Top"><i class="svgs svgh angu"></i></a>
</span>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://haruband.github.io/js/theme.min.js" integrity="sha384-pb++s6uBRKaQv+iAXpgA/H3IlpLZdO14tTwuCI7uXmz4aaZdByoCcM+6BhynMq/1"></script>
  <link rel="stylesheet" href="https://haruband.github.io/abridge.css?h=98ebdf6fd3d59dfb2edf" />
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="base" content="https://haruband.github.io" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#333333" />
  <meta name="msapplication-TileColor" content="#333333" />
  <link rel="manifest" href="https://haruband.github.io/manifest.min.json" />
  <link rel="mask-icon" href="https://haruband.github.io/safari-pinned-tab.svg" color="#ff9900" />
  <link rel="icon" type="image/svg+xml" href="https://haruband.github.io/favicon.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://haruband.github.io/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://haruband.github.io/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://haruband.github.io/favicon-16x16.png" />
  <link rel="alternate" type="application/atom+xml" title="CodeBook Atom Feed" href="https://haruband.github.io/atom.xml" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <title>[Arrow/Datafusion] 성능 평가 (Spark) | CodeBook</title>
  <meta name="author" content="Inhyeok Kim" />
  <meta name="copyright" content="CodeBook" />
  <meta name="description" content="Haruband&#x27;s TechBlog" />
  <link rel="canonical" href="https://haruband.github.io/datafusion-benchmark/" />
  <meta name="keywords" content="Arrow, Datafusion, Kubernetes" />
  <meta name="google-site-verification" content="Your Google Site verification code." />
  <meta name="msvalidate.01" content="Your Bing Site verification code." />
  <meta property="og:url" content="https://haruband.github.io/datafusion-benchmark/" />
  <meta name="twitter:url" content="https://haruband.github.io/datafusion-benchmark/" />
  <meta property="og:description" content="Haruband&#x27;s TechBlog" />
  <meta name="twitter:description" content="Haruband&#x27;s TechBlog" />
  <meta property="og:title" content="[Arrow&#x2F;Datafusion] 성능 평가 (Spark) | CodeBook" />
  <meta name="twitter:title" content="[Arrow&#x2F;Datafusion] 성능 평가 (Spark) | CodeBook" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://haruband.github.io/banner.png" />
  <meta property="og:image" content="https://haruband.github.io/banner.png" />
  <meta property="og:site_name" content="CodeBook" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:type" content="website" />
  <meta property="og:updated_time" content="2024-12-16" />
  <meta name="twitter:site" content="@your-user-name" />
  <meta name="twitter:creator" content="@your-user-name" />
  <script defer src="https://haruband.github.io/js/abridge.min.js?h=e0f9a881a665c86cce9c" integrity="sha384-QF67y7RnPkuDrJNQqn3/7nYxqxWkW/qHI7zN0WTES1aXbf+TotoByRBb835fUE6U"></script>
  <noscript><link rel="stylesheet" href="https://haruband.github.io/nojs.css" /></noscript>
</head>
<body>
  <header>
    <nav>
      <div><big><a href="https://haruband.github.io" title="CodeBook">CodeBook</a></big></div>
      <div>

        <div>
          <ul><li><a class="s110" href="https://haruband.github.io/archive/"> Posts </a></li><li><a class="s110" href="https://haruband.github.io/tags/"> Tags </a></li><li><i type="reset" id="mode" class="js svgs adjust"></i></ul>
        </div>

        <div>
          <div>
            <form autocomplete=off class="js" name="goSearch" id="searchbox">
              <div class="searchd">
                <input id="searchinput" type="text" placeholder="Search" title="Search" />
                <button type="submit" title="Search" class="svgs svgm search"></button>
              </div>
              <div class="results"><div id="suggestions"></div></div>
            </form>
          </div>
        </div>

      </div>
    </nav>
  </header>
  <main>
    <article>
      <h1><a href="https://haruband.github.io/datafusion-benchmark/">[Arrow&#x2F;Datafusion] 성능 평가 (Spark)</a></h1>

      <span class="s95"> Inhyeok Kim <span class="rpad"></span> December 16, 2024 <span class="rpad"></span>Updated: December 16, 2024 <span class="rpad"></span> #<a href="https://haruband.github.io/tags/arrow/">Arrow</a>  #<a href="https://haruband.github.io/tags/datafusion/">Datafusion</a>  #<a href="https://haruband.github.io/tags/spark/">Spark</a> </span>

    
        <div class="block">
      <div class="blockdiv">
        <a class="b s150" href="https://haruband.github.io/tags/datafusion/">Datafusion (Series)</a><br>
            <a href="https://haruband.github.io/datafusion-overview/">[Arrow&#x2F;Datafusion] 동작 과정 분석</a><br>
            <a href="https://haruband.github.io/datafusion-aggregation/">[Arrow&#x2F;Datafusion] 동작 과정 분석 (Aggregation)</a><br>
            <a href="https://haruband.github.io/datafusion-join/">[Arrow&#x2F;Datafusion] 동작 과정 분석 (Join)</a><br>
            <a class="scur" href="https://haruband.github.io/datafusion-benchmark/">[Arrow&#x2F;Datafusion] 성능 평가 (Spark)</a><br> 
          
      </div>
    </div>


<p><a rel="noopener" target="_blank" href="https://github.com/apache/datafusion">Datafusion</a> 은 <a rel="noopener" target="_blank" href="https://arrow.apache.org">Arrow</a> 를 이용하여 Rust 기반으로 개발 중인 임베딩 SQL 엔진이다. 그래서 Scala 기반으로 개발되어 JVM 위에서 동작하는 <a rel="noopener" target="_blank" href="https://spark.apache.org">Spark</a> 에 비해 아래와 같은 장점을 가진다.</p>
<ul>
<li>GC 없이 메모리 안정성 보장</li>
<li>컬럼 기반 데이터 포맷 사용 (Arrow)</li>
<li>LLVM 기반 최적화 (Vectorization, ...)</li>
</ul>
<p>그렇다면 이러한 장점들이 실제 성능에는 얼마나 영향을 주는지 알아보도록 하자. 오늘은 단일 머신에서의 성능만을 비교하고, 추후에 <a rel="noopener" target="_blank" href="https://datafusion.apache.org/ballista">Ballista</a> 와 같은 Datafusion 기반의 분산 처리 기술을 이용하여 분산 처리 성능도 비교해보도록 하겠다.</p>
<p>실험은 OLAP 성능 검증을 위해 자주 사용되는 TPC-H (SF1000) 를 이용하였다. 실험 결과는 처리 시간과 메모리 사용량을 이용하여 분석하였으며, 최대 메모리 사용량(JVM)에 영향을 많이 받는 Spark 는 8 ~ 64 GB 까지 최대 메모리 사용량을 변경해가면서 성능을 측정하였다.</p>
<p>첫 번째 실험은 하나의 테이블에서 몇 가지 조건절을 이용하여 데이터를 필터링한 다음 합계를 구하는 쿼리(TPC-H-Q6)이다.</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">select</span>
</span><span class="z-source z-sql">    <span class="z-support z-function z-aggregate z-sql">sum</span>(l_extendedprice <span class="z-variable z-language z-star z-sql">*</span> l_discount) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> revenue
</span><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">from</span>
</span><span class="z-source z-sql">    lineitem
</span><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">where</span>
</span><span class="z-source z-sql">    l_shipdate <span class="z-keyword z-operator z-comparison z-sql">&gt;=</span> <span class="z-storage z-type z-sql">date</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>1994-01-01<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>
</span><span class="z-source z-sql">    <span class="z-keyword z-operator z-logical z-sql">and</span> l_shipdate <span class="z-keyword z-operator z-comparison z-sql">&lt;</span> <span class="z-storage z-type z-sql">date</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>1995-01-01<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>
</span><span class="z-source z-sql">    <span class="z-keyword z-operator z-logical z-sql">and</span> l_discount <span class="z-keyword z-operator z-logical z-sql">between</span> <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">06</span> <span class="z-keyword z-operator z-math z-sql">-</span> <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">01</span> <span class="z-keyword z-operator z-logical z-sql">and</span> <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">06</span> <span class="z-keyword z-operator z-math z-sql">+</span> <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">01</span>
</span><span class="z-source z-sql">    <span class="z-keyword z-operator z-logical z-sql">and</span> l_quantity <span class="z-keyword z-operator z-comparison z-sql">&lt;</span> <span class="z-constant z-numeric z-sql">24</span>;
</span></code></pre>
<p>아래는 처리 시간을 보여주고 있다. Datafusion 이 Spark 에 비해 대략 10 배 정도 좋은 성능을 보여주고 있다.</p>
<p><img src="https://haruband.github.io/datafusion-benchmark/./tpch.q6.png" alt="tpch.q6.png" /></p>
<p>아래는 실제 메모리 사용량을 측정한 결과이다. Datafusion 은 최대 1.8 GB 정도의 메모리를 사용하였으며, Spark 는 최대 메모리 사용량(-Xmx)이 클수록 실제 메모리 사용량이 커지면서 오히려 성능이 약간 떨어지는 모습을 볼 수 있다. Spark 는 중간 결과나 재활용할 수 있는 데이터를 메모리에 최대한 유지하는 정책을 취하기 때문에 메모리 사용량이 증가하면서 GC(GarbageCollection) 오버헤드를 증가시키는 등 오히려 안 좋은 결과를 보여줄 수 있다. (최대 메모리 사용량이 8 GB 일때는 GC 에 1.5 초를 소요했지만, 64 GB 일때는 2.4 초를 소요했다.)</p>
<p><img src="https://haruband.github.io/datafusion-benchmark/./memory.q6.png" alt="memory.q6.png" /></p>
<p>두 번째 실험은 하나의 테이블에서 그룹별 집계를 구하는 쿼리(TPC-H-Q1)이다.</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">select</span>
</span><span class="z-source z-sql">    l_returnflag,
</span><span class="z-source z-sql">    l_linestatus,
</span><span class="z-source z-sql">    <span class="z-support z-function z-aggregate z-sql">sum</span>(l_quantity) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> sum_qty,
</span><span class="z-source z-sql">    <span class="z-support z-function z-aggregate z-sql">sum</span>(l_extendedprice) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> sum_base_price,
</span><span class="z-source z-sql">    <span class="z-support z-function z-aggregate z-sql">sum</span>(l_extendedprice <span class="z-variable z-language z-star z-sql">*</span> (<span class="z-constant z-numeric z-sql">1</span> <span class="z-keyword z-operator z-math z-sql">-</span> l_discount)) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> sum_disc_price,
</span><span class="z-source z-sql">    <span class="z-support z-function z-aggregate z-sql">sum</span>(l_extendedprice <span class="z-variable z-language z-star z-sql">*</span> (<span class="z-constant z-numeric z-sql">1</span> <span class="z-keyword z-operator z-math z-sql">-</span> l_discount) <span class="z-variable z-language z-star z-sql">*</span> (<span class="z-constant z-numeric z-sql">1</span> <span class="z-keyword z-operator z-math z-sql">+</span> l_tax)) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> sum_charge,
</span><span class="z-source z-sql">    <span class="z-support z-function z-aggregate z-sql">avg</span>(l_quantity) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> avg_qty,
</span><span class="z-source z-sql">    <span class="z-support z-function z-aggregate z-sql">avg</span>(l_extendedprice) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> avg_price,
</span><span class="z-source z-sql">    <span class="z-support z-function z-aggregate z-sql">avg</span>(l_discount) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> avg_disc,
</span><span class="z-source z-sql">    <span class="z-support z-function z-aggregate z-sql">count</span>(<span class="z-variable z-language z-star z-sql">*</span>) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> count_order
</span><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">from</span>
</span><span class="z-source z-sql">    lineitem
</span><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">where</span>
</span><span class="z-source z-sql">    l_shipdate <span class="z-keyword z-operator z-comparison z-sql">&lt;=</span> <span class="z-storage z-type z-sql">date</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>1998-09-02<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>
</span><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">group by</span>
</span><span class="z-source z-sql">    l_returnflag,
</span><span class="z-source z-sql">    l_linestatus
</span><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">order by</span>
</span><span class="z-source z-sql">    l_returnflag,
</span><span class="z-source z-sql">    l_linestatus;
</span></code></pre>
<p>Datafusion 이 Spark 에 비해 대략 10 ~ 12 배 정도 좋은 성능을 보여주고 있다.</p>
<p><img src="https://haruband.github.io/datafusion-benchmark/./tpch.q1.png" alt="tpch.q1.png" /></p>
<p>Datafusion 은 최대 2 GB 정도의 메모리를 사용하였으며, Spark 는 앞의 실험과 유사한 결과를 보여주지만 그룹별 집계가 메모리 사용량이 많기 때문에 성능이 나빠지는 정도가 훨씬 심해진 것을 볼 수 있다. (최대 메모리 사용량이 8 GB 일때는 GC 에 21 초를 소요했지만, 64 GB 일때는 40 초를 소요했다.)</p>
<p><img src="https://haruband.github.io/datafusion-benchmark/./memory.q1.png" alt="memory.q1.png" /></p>
<p>세 번째 실험은 두 개의 테이블을 조인하는 쿼리(TPC-H-Q12)이다. 등가(Equal) 조인을 처리하는 방식은 BroadcastJoin, HashJoin, SortMergeJoin 등이 있는데, 이번 실험에서는 최적화가 충분치 않은 Datafusion 의 SortMergeJoin 과 데이터 크기가 커서 사용할 수 없는 Spark 의 BroadcastJoin 은 제외하고 진행하였다.</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">select</span>
</span><span class="z-source z-sql">    l_shipmode,
</span><span class="z-source z-sql">    <span class="z-support z-function z-aggregate z-sql">sum</span>(<span class="z-keyword z-other z-DML z-sql">case</span>
</span><span class="z-source z-sql">            <span class="z-keyword z-other z-DML z-sql">when</span> o_orderpriority <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>1-URGENT<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>
</span><span class="z-source z-sql">                <span class="z-keyword z-operator z-logical z-sql">or</span> o_orderpriority <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>2-HIGH<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>
</span><span class="z-source z-sql">                <span class="z-keyword z-other z-DML z-sql">then</span> <span class="z-constant z-numeric z-sql">1</span>
</span><span class="z-source z-sql">            <span class="z-keyword z-other z-DML z-sql">else</span> <span class="z-constant z-numeric z-sql">0</span>
</span><span class="z-source z-sql">        <span class="z-keyword z-other z-DML z-sql">end</span>) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> high_line_count,
</span><span class="z-source z-sql">    <span class="z-support z-function z-aggregate z-sql">sum</span>(<span class="z-keyword z-other z-DML z-sql">case</span>
</span><span class="z-source z-sql">            <span class="z-keyword z-other z-DML z-sql">when</span> o_orderpriority <span class="z-keyword z-operator z-comparison z-sql">&lt;&gt;</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>1-URGENT<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>
</span><span class="z-source z-sql">                <span class="z-keyword z-operator z-logical z-sql">and</span> o_orderpriority <span class="z-keyword z-operator z-comparison z-sql">&lt;&gt;</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>2-HIGH<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>
</span><span class="z-source z-sql">                <span class="z-keyword z-other z-DML z-sql">then</span> <span class="z-constant z-numeric z-sql">1</span>
</span><span class="z-source z-sql">            <span class="z-keyword z-other z-DML z-sql">else</span> <span class="z-constant z-numeric z-sql">0</span>
</span><span class="z-source z-sql">        <span class="z-keyword z-other z-DML z-sql">end</span>) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> low_line_count
</span><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">from</span>
</span><span class="z-source z-sql">    lineitem
</span><span class="z-source z-sql">    <span class="z-keyword z-other z-DML z-sql">join</span> orders on l_orderkey <span class="z-keyword z-operator z-comparison z-sql">=</span> o_orderkey
</span><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">where</span>
</span><span class="z-source z-sql">    l_shipmode <span class="z-keyword z-operator z-logical z-sql">in</span> (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>MAIL<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>SHIP<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>)
</span><span class="z-source z-sql">    <span class="z-keyword z-operator z-logical z-sql">and</span> l_commitdate <span class="z-keyword z-operator z-comparison z-sql">&lt;</span> l_receiptdate
</span><span class="z-source z-sql">    <span class="z-keyword z-operator z-logical z-sql">and</span> l_shipdate <span class="z-keyword z-operator z-comparison z-sql">&lt;</span> l_commitdate
</span><span class="z-source z-sql">    <span class="z-keyword z-operator z-logical z-sql">and</span> l_receiptdate <span class="z-keyword z-operator z-comparison z-sql">&gt;=</span> <span class="z-storage z-type z-sql">date</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>1994-01-01<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>
</span><span class="z-source z-sql">    <span class="z-keyword z-operator z-logical z-sql">and</span> l_receiptdate <span class="z-keyword z-operator z-comparison z-sql">&lt;</span> <span class="z-storage z-type z-sql">date</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>1995-01-01<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>
</span><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">group by</span>
</span><span class="z-source z-sql">    l_shipmode
</span><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">order by</span>
</span><span class="z-source z-sql">    l_shipmode;
</span></code></pre>
<p>Datafusion 의 BroadcastJoin 이 가장 좋은 성능을 보여주고 있으며, Spark 에 비해 대략 7.6 배 정도 좋은 성능을 보여주고 있다.</p>
<p><img src="https://haruband.github.io/datafusion-benchmark/./tpch.q12.png" alt="tpch.q12.png" /></p>
<p>Datafusion 은 BroadcastJoin 과 HashJoin 에서 2.5 GB 정도의 메모리를 사용하였으며, Spark 는 HashJoin 에서 64 GB 의 메모리도 부족하여 파티션을 두 배(400)로 늘려서 실험하였다.</p>
<p><img src="https://haruband.github.io/datafusion-benchmark/./memory.q12.png" alt="memory.q12.png" /></p>
<p>실험 결과를 종합해보면, Datafusion 이 훨씬 적은 메모리를 사용하면서도 10 배 정도 좋은 성능을 보여주고 있다. 또한, Spark 는 최대 메모리 사용량에 따른 실제 메모리 사용량과 처리 시간을 예측하기 힘들고, 최대 메모리 사용량이 부족하면 예기치 못한 OOM(OutOfMemory) 도 자주 발생하기 때문에 사용하기가 매우 까다롭다.</p>
<p>마지막으로 Datafusion 이 어떻게 좋은 성능을 보여주는지 살펴보도록 하자.</p>
<p>첫 번째 이유는 GC 를 사용하지 않기 때문이다. GC 를 사용하면 메모리를 반환하더라도 GC 에 의해 해제되기 전까지 재사용이 불가능하기 때문에 실제 메모리 사용량보다 많은 메모리를 사용할 수 밖에 없고, 실제 메모리 사용량을 정확히 예측하기 어렵다. 그리고 최대 메모리 사용량을 늘리면 GC 에 의해 관리되는 영역이 커지기 때문에 그만큼 오버헤드가 증가하지만, 최대 메모리 사용량을 줄이면 예기치 못한 OOM 이 발생한다. 반면에, GC 를 사용하지 않고 시스템 메모리를 바로 사용하면 메모리를 반환하는 즉시 재사용이 가능하고, 최대 메모리 사용량을 별도로 설정할 필요없이 시스템 메모리를 최대로 활용할 수 있으며 스왑까지 충분히 활용한다면 이론적으로는 OOM 은 발생하지 않는다.</p>
<p>두 번째 이유는 컬럼 기반 데이터 포맷을 사용하기 때문이다. 이로 인해 캐시 효율이 높아지고, 아래 소개할 LLVM 을 이용한 AutoVectorization 도 가능해진다.</p>
<p>세 번째 이유는 LLVM 을 이용하여 최적화하기 때문이다. Spark 는 바이트코드로 배포되어 JIT(JustInTime) 기술을 이용하여 실행되기 때문에 충분한 최적화를 하기가 힘들지만, Datafusion 은 LLVM 으로 컴파일한 네이티브코드를 배포하기 때문에 충분한 최적화를 할 수 있다. 이로 인해 컬럼 기반 데이터 포맷을 사용하는 Datafusion 에서는 각각의 컬럼이 연속된 메모리 공간을 차지하기 때문에 최소한의 노력으로 Vectorization 과 같은 하드웨어 가속을 바로 사용할 수 있게 된다.</p>
<p>8 개 정수의 합을 구하는 간단한 예제를 통해 LLVM 이 어떻게 연속된 메모리에 대한 반복 연산을 최적화하는지 살펴보자.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">loop_simple</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">a</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span>[<span class="z-storage z-type z-rust">i32</span>; 8]</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-storage z-type z-rust">i32</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> r<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">i32</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> var <span class="z-keyword z-operator z-rust">in</span> a<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">iter</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        r <span class="z-keyword z-operator z-assignment z-rust">+=</span> var<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    r
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>아래는 위의 코드를 최적화 없이 컴파일한 결과이다. 많은 명령어와 메모리 접근이 빈번하게 발생하는 것을 볼 수 있다.</p>
<pre class="z-code"><code><span class="z-text z-plain">       0: 48 83 ec 38                   subq  $56, %rsp
</span><span class="z-text z-plain">       4: 48 89 7c 24 28                movq  %rdi, 40(%rsp)
</span><span class="z-text z-plain">       9: c7 44 24 0c 00 00 00 00       movl  $0, 12(%rsp)
</span><span class="z-text z-plain">      11: be 08 00 00 00                movl  $8, %esi
</span><span class="z-text z-plain">      16: ff 15 00 00 00 00             callq *(%rip)
</span><span class="z-text z-plain">      1c: 48 89 c7                      movq  %rax, %rdi
</span><span class="z-text z-plain">      1f: 48 89 d6                      movq  %rdx, %rsi
</span><span class="z-text z-plain">      22: ff 15 00 00 00 00             callq *(%rip)
</span><span class="z-text z-plain">      28: 48 89 44 24 10                movq  %rax, 16(%rsp)
</span><span class="z-text z-plain">      2d: 48 89 54 24 18                movq  %rdx, 24(%rsp)
</span><span class="z-text z-plain">      32: 48 8d 7c 24 10                leaq  16(%rsp), %rdi
</span><span class="z-text z-plain">      37: ff 15 00 00 00 00             callq *(%rip)
</span><span class="z-text z-plain">      3d: 48 89 44 24 20                movq  %rax, 32(%rsp)
</span><span class="z-text z-plain">      42: 48 8b 54 24 20                movq  32(%rsp), %rdx
</span><span class="z-text z-plain">      47: b8 01 00 00 00                movl  $1, %eax
</span><span class="z-text z-plain">      4c: 31 c9                         xorl  %ecx, %ecx
</span><span class="z-text z-plain">      4e: 48 83 fa 00                   cmpq  $0, %rdx
</span><span class="z-text z-plain">      52: 48 0f 44 c1                   cmoveq  %rcx, %rax
</span><span class="z-text z-plain">      56: 48 83 f8 00                   cmpq  $0, %rax
</span><span class="z-text z-plain">      5a: 75 09                         jne 0x65
</span><span class="z-text z-plain">      5c: 8b 44 24 0c                   movl  12(%rsp), %eax
</span><span class="z-text z-plain">      60: 48 83 c4 38                   addq  $56, %rsp
</span><span class="z-text z-plain">      64: c3                            retq
</span><span class="z-text z-plain">      65: 48 8b 74 24 20                movq  32(%rsp), %rsi
</span><span class="z-text z-plain">      6a: 48 89 74 24 30                movq  %rsi, 48(%rsp)
</span><span class="z-text z-plain">      6f: 48 8d 7c 24 0c                leaq  12(%rsp), %rdi
</span><span class="z-text z-plain">      74: 48 8d 15 00 00 00 00          leaq  (%rip), %rdx
</span><span class="z-text z-plain">      7b: e8 00 00 00 00                callq 0x80
</span><span class="z-text z-plain">      80: eb b0                         jmp 0x32
</span><span class="z-text z-plain">      ...
</span></code></pre>
<p>아래는 Vectorization 이 적용된 결과이다. 위의 코드에 비해 훨씬 적은 명령어와 메모리 접근이 발생하는 것을 볼 수 있다.</p>
<pre class="z-code"><code><span class="z-text z-plain">       0: f3 0f 6f 07                   movdqu  (%rdi), %xmm0
</span><span class="z-text z-plain">       4: f3 0f 6f 4f 10                movdqu  16(%rdi), %xmm1
</span><span class="z-text z-plain">       9: 66 0f fe c8                   paddd   %xmm0, %xmm1
</span><span class="z-text z-plain">       d: 66 0f 70 c1 ee                pshufd  $238, %xmm1, %xmm0
</span><span class="z-text z-plain">      12: 66 0f fe c1                   paddd   %xmm1, %xmm0
</span><span class="z-text z-plain">      16: 66 0f 70 c8 55                pshufd  $85, %xmm0, %xmm1
</span><span class="z-text z-plain">      1b: 66 0f fe c8                   paddd   %xmm0, %xmm1
</span><span class="z-text z-plain">      1f: 66 0f 7e c8                   movd    %xmm1, %eax
</span><span class="z-text z-plain">      23: c3                            retq
</span></code></pre>
<p>지금까지 몇 가지 실험을 통해 Datafusion 과 Spark 의 성능을 검증 및 분석해보았다. Datafusion 은 아직 공개된지 오래되지 않았고, 매우 활발하게 개발 중이기 때문에 앞으로 더 좋은 성능을 보여줄 것으로 기대하고 있다. 그리고 Spark 와 Trino 도 자바의 한계를 벗어나기 위해 핵심 쿼리 엔진을 <a rel="noopener" target="_blank" href="https://www.databricks.com/product/photon">Photon</a> 이나 <a rel="noopener" target="_blank" href="https://github.com/facebookincubator/velox">Velox</a> 로 교체하려는 시도를 하고 있고, <a rel="noopener" target="_blank" href="https://github.com/apache/datafusion-comet">Spark 의 쿼리 엔진을 Datafusion 으로 교체하려는 시도</a>도 이미 진행 중이기 때문에 앞으로 많은 변화가 있을 것으로 기대된다.</p>

      <nav>
        <div>
        </div>
        <div>
          <a href="https://haruband.github.io/datafusion-join/"> [Arrow&#x2F;Datafusion] 동작 과정 분석 (Join) &#8250;</a>
        </div>
      </nav>
    </article>

    <div class="sblock">
      <div class="blockdiv">
        <a class="b s150" href="https://haruband.github.io/tags/datafusion/">Series</a><br>
            
      <a href="https://haruband.github.io/datafusion-overview/">[Arrow&#x2F;Datafusion] 동작 과정 분석</a><br>
            
      <a href="https://haruband.github.io/datafusion-aggregation/">[Arrow&#x2F;Datafusion] 동작 과정 분석 (Aggregation)</a><br>
            
      <a href="https://haruband.github.io/datafusion-join/">[Arrow&#x2F;Datafusion] 동작 과정 분석 (Join)</a><br>
            
      <a class="scur" href="https://haruband.github.io/datafusion-benchmark/">[Arrow&#x2F;Datafusion] 성능 평가 (Spark)</a><br>
    
      </div>
  </main>
  <footer>
    <div class="c">
      <nav class="tpad"><div><a href="https://www.linkedin.com/in/inhyeok-kim-7620a0b0/" target="_blank" title="LinkedIn"><i type="Button" class="svg linkedin" title="LinkedIn"></i></a><a href="https://github.com/haruband/" target="_blank" title="Github"><i type="Button" class="svg github" title="Github"></i></a></div></nav>
      <nav class="vpad">
        <a class="rpad s90" href="https://haruband.github.io/about/"> About </a>
        <a class="rpad s90" href="https://haruband.github.io/contact/"> Contact </a>
      </nav>
      <p class="s80"> &copy; <span id="year">2025</span> CodeBook</p>
      <p class="s80">Powered by <a href="https://www.getzola.org/" target="_blank">Zola</a> & <a href="https://github.com/jieiku/abridge/" target="_blank">Abridge</a></p>
    </div>
  </footer><span class="topout">
<span class="topleft"> </span><a href="#" class="top" title="Back to Top"><i class="svgs svgh angu"></i></a>
</span>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://haruband.github.io/js/theme.min.js" integrity="sha384-pb++s6uBRKaQv+iAXpgA/H3IlpLZdO14tTwuCI7uXmz4aaZdByoCcM+6BhynMq/1"></script>
  <link rel="stylesheet" href="https://haruband.github.io/abridge.css?h=98ebdf6fd3d59dfb2edf" />
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="base" content="https://haruband.github.io" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#333333" />
  <meta name="msapplication-TileColor" content="#333333" />
  <link rel="manifest" href="https://haruband.github.io/manifest.min.json" />
  <link rel="mask-icon" href="https://haruband.github.io/safari-pinned-tab.svg" color="#ff9900" />
  <link rel="icon" type="image/svg+xml" href="https://haruband.github.io/favicon.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://haruband.github.io/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://haruband.github.io/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://haruband.github.io/favicon-16x16.png" />
  <link rel="alternate" type="application/atom+xml" title="CodeBook Atom Feed" href="https://haruband.github.io/atom.xml" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <title>[Delta] 델타로그 최적화 | CodeBook</title>
  <meta name="author" content="Inhyeok Kim" />
  <meta name="copyright" content="CodeBook" />
  <meta name="description" content="Haruband&#x27;s TechBlog" />
  <link rel="canonical" href="https://haruband.github.io/delta-optimize/" />
  <meta name="keywords" content="Arrow, Datafusion, Kubernetes" />
  <meta name="google-site-verification" content="Your Google Site verification code." />
  <meta name="msvalidate.01" content="Your Bing Site verification code." />
  <meta property="og:url" content="https://haruband.github.io/delta-optimize/" />
  <meta name="twitter:url" content="https://haruband.github.io/delta-optimize/" />
  <meta property="og:description" content="Haruband&#x27;s TechBlog" />
  <meta name="twitter:description" content="Haruband&#x27;s TechBlog" />
  <meta property="og:title" content="[Delta] 델타로그 최적화 | CodeBook" />
  <meta name="twitter:title" content="[Delta] 델타로그 최적화 | CodeBook" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://haruband.github.io/banner.png" />
  <meta property="og:image" content="https://haruband.github.io/banner.png" />
  <meta property="og:site_name" content="CodeBook" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:type" content="website" />
  <meta property="og:updated_time" content="2022-01-08" />
  <meta name="twitter:site" content="@your-user-name" />
  <meta name="twitter:creator" content="@your-user-name" />
  <script defer src="https://haruband.github.io/js/abridge.min.js?h=e0f9a881a665c86cce9c" integrity="sha384-QF67y7RnPkuDrJNQqn3/7nYxqxWkW/qHI7zN0WTES1aXbf+TotoByRBb835fUE6U"></script>
  <noscript><link rel="stylesheet" href="https://haruband.github.io/nojs.css" /></noscript>
</head>
<body>
  <header>
    <nav>
      <div><big><a href="https://haruband.github.io" title="CodeBook">CodeBook</a></big></div>
      <div>

        <div>
          <ul><li><a class="s110" href="https://haruband.github.io/archive/"> Posts </a></li><li><a class="s110" href="https://haruband.github.io/tags/"> Tags </a></li><li><i type="reset" id="mode" class="js svgs adjust"></i></ul>
        </div>

        <div>
          <div>
            <form autocomplete=off class="js" name="goSearch" id="searchbox">
              <div class="searchd">
                <input id="searchinput" type="text" placeholder="Search" title="Search" />
                <button type="submit" title="Search" class="svgs svgm search"></button>
              </div>
              <div class="results"><div id="suggestions"></div></div>
            </form>
          </div>
        </div>

      </div>
    </nav>
  </header>
  <main>
    <article>
      <h1><a href="https://haruband.github.io/delta-optimize/">[Delta] 델타로그 최적화</a></h1>

      <span class="s95"> Inhyeok Kim <span class="rpad"></span> January 08, 2022 <span class="rpad"></span>Updated: January 08, 2022 <span class="rpad"></span> #<a href="https://haruband.github.io/tags/delta/">Delta</a> </span>

    
        <div class="block">
      <div class="blockdiv">
        <a class="b s150" href="https://haruband.github.io/tags/delta/">Delta (Series)</a><br>
            <a href="https://haruband.github.io/delta-overview/">[Delta] 델타로그 분석</a><br>
            <a class="scur" href="https://haruband.github.io/delta-optimize/">[Delta] 델타로그 최적화</a><br> 
          
            <a href="https://haruband.github.io/delta-filtering/">[Delta] 읽기 성능 최적화</a><br>
            <a href="https://haruband.github.io/delta-checkpoints/">[Delta] 델타로그 체크포인트 분석</a><br>
            <a href="https://haruband.github.io/delta-cleanup/">[Delta] 델타로그 CleanUp 문제 분석</a><br>
      </div>
    </div>


<p>델타레이크는 쓰기 작업이나 여러 최적화 과정(Compaction, Z-Order, ...)이 반복될수록 로그가 쌓여간다. 이렇게 로그가 지속적으로 쌓여가면 마지막 상태 정보를 담고 있는 스냅샷을 만드는 작업이 점점 더 오래 걸릴 수 밖에 없어진다. 이 문제를 개선하기 위해 델타레이크는 몇 가지 기능을 제공하고 있다. 오늘은 이에 대해 간단히 살펴보고자 한다.</p>
<h2 id="jinagan-rogeu-pail-jeongri">지나간 로그 파일 정리</h2>
<p>로그 파일이 많아져도 스냅샷을 만들 때는 마지막 체크포인트 파일과 이후의 로그 파일만 사용되지만, 로그 파일이 많아지는 것 자체가 스토리지에 부담을 준다. 그래서 델타레이크는 일정 기간이 지난 로그 파일을 제거하는 기능을 제공하고 있다. 사용법은 아래와 같다.
(현재 S3 스토리지의 경우, 특정 버전 이후의 로그 파일을 가져오는 listFrom() 함수가 모든 로그 파일을 가져온 다음 필터링하는 방식으로 동작하고 있기 때문에 특히 문제가 심각하다. 하지만, 현재 이를 해결하기 위한 <a rel="noopener" target="_blank" href="https://github.com/delta-io/delta/pull/1210">PR</a>이 대기 중이다.)</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">config</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">spark.databricks.delta.properties.defaults.logRetentionDuration<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">interval 7 days<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre>
<p>해당 옵션의 기본값은 30 일이고, 위와 같이 7 일로 지정하면 체크포인트 파일을 만들 때마다 7 일이 지난 로그 파일들은 제거한다. 여기서 주의할 점은 마지막 체크포인트 이후의 로그 파일은 제거되지 않는다. 이유는 아직 해당 로그 파일의 내용이 어떤 체크포인트 파일에도 포함되지 않았기 때문이다. 그리고 또 한 가지 주의할 점은 해당 기간 이전으로는 롤백할 수 없게 된다. 이유는 롤백할 때 마지막 체크포인트부터 지정한 버전까지의 로그 파일들이 필요하기 때문이다.</p>
<h2 id="jiweojin-pail-rogeu-jeongri">지워진 파일 로그 정리</h2>
<p>로그가 쌓이면 체크포인트 파일의 크기도 꾸준히 증가하기 때문에 스냅샷을 만들 때 문제가 될 수 있다. 이를 개선하기 위해서는 불필요한 로그를 꾸준히 없애주는 작업이 필요하다. 델타레이크는 데이터에 대한 변경이나 최적화를 할 때 기존 데이터 파일은 그대로 두고 새로운 데이터 파일을 추가하기 때문에 기존 데이터 파일은 롤백할 때를 제외하곤 필요없어진다. 그래서 아래와 같이 옵션을 지정하면 체크포인트 파일을 만들 때마다 해당 기간이 지난 불필요한 로그들은 제거된다. 여기서 말하는 불필요한 로그들은 데이터 파일을 삭제(remove)하는 로그와 해당 데이터 파일을 추가(add)했던 로그이다.</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">config</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">spark.databricks.delta.properties.defaults.deletedFileRetentionDuration<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">interval 15 days<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre>
<p>참고로, 델타레이크가 제공하는 Vacuum 명령어는 지정한 기간이 지난 불필요한 데이터 파일을 지우는 역할을 한다. 위의 기능과는 별개로 동작한다.</p>
<h2 id="cekeupointeu-pail-jjogaegi">체크포인트 파일 쪼개기</h2>
<p>델타레이크는 내부적으로 스파크를 사용하고 있기 때문에 스냅샷은 스파크의 데이터프레임으로 만들어진다. 그래서 체크포인트 파일을 여러 개의 파일로 쪼개서 병렬로 읽고/쓰는 것이 가능하다. 특히, 이 기능은 스파크 스트리밍을 통해 실시간으로 데이터를 델타레이크에 저장할 때 유용하다. 해당 기능이 없다면, 스파크 스트리밍에서 10 번에 한 번씩 하나의 익스큐터에서 체크포인트 파일을 만드는 것을 기다려야 하기 때문에 반복적인 지연이 발생할 수 밖에 없다. 하지만 해당 기능을 사용하면 10 번에 한 번씩 체크포인트 파일을 만드는 작업을 여러 익스큐터에서 병렬로 처리할 수 있기 때문에 지연 시간을 줄일 수 있다.</p>
<p>지금까지 델타레이크에서 지속적으로 쌓여가는 로그를 어떻게 효율적으로 관리하는지 살펴보았다.</p>

      <nav>
        <div>
          <a href="https://haruband.github.io/delta-filtering/">&#8249; [Delta] 읽기 성능 최적화</a>
        </div>
        <div>
          <a href="https://haruband.github.io/delta-overview/"> [Delta] 델타로그 분석 &#8250;</a>
        </div>
      </nav>
    </article>

    <div class="sblock">
      <div class="blockdiv">
        <a class="b s150" href="https://haruband.github.io/tags/delta/">Series</a><br>
            
      <a href="https://haruband.github.io/delta-overview/">[Delta] 델타로그 분석</a><br>
            
      <a class="scur" href="https://haruband.github.io/delta-optimize/">[Delta] 델타로그 최적화</a><br>
    
            
      <a href="https://haruband.github.io/delta-filtering/">[Delta] 읽기 성능 최적화</a><br>
            
      <a href="https://haruband.github.io/delta-checkpoints/">[Delta] 델타로그 체크포인트 분석</a><br>
            
      <a href="https://haruband.github.io/delta-cleanup/">[Delta] 델타로그 CleanUp 문제 분석</a><br>
      </div>
      <div class="blockdiv sticky">
        <a class="b s150" href="#">Index</a>
        <div>
          <a href="#jinagan-rogeu-pail-jeongri">지나간 로그 파일 정리</a>
        </div>
        <div>
          <a href="#jiweojin-pail-rogeu-jeongri">지워진 파일 로그 정리</a>
        </div>
        <div>
          <a href="#cekeupointeu-pail-jjogaegi">체크포인트 파일 쪼개기</a>
        </div>
      </div>
    </div>
  </main>
  <footer>
    <div class="c">
      <nav class="tpad"><div><a href="https://www.linkedin.com/in/inhyeok-kim-7620a0b0/" target="_blank" title="LinkedIn"><i type="Button" class="svg linkedin" title="LinkedIn"></i></a><a href="https://github.com/haruband/" target="_blank" title="Github"><i type="Button" class="svg github" title="Github"></i></a></div></nav>
      <nav class="vpad">
        <a class="rpad s90" href="https://haruband.github.io/about/"> About </a>
        <a class="rpad s90" href="https://haruband.github.io/contact/"> Contact </a>
      </nav>
      <p class="s80"> &copy; <span id="year">2025</span> CodeBook</p>
      <p class="s80">Powered by <a href="https://www.getzola.org/" target="_blank">Zola</a> & <a href="https://github.com/jieiku/abridge/" target="_blank">Abridge</a></p>
    </div>
  </footer>
</body>
</html>
